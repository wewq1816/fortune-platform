# 🔍 방문자 로그가 왜 쌓이는지 + 초기화해도 되는지 완벽 설명

## 📊 방문자 로그가 왜 쌓이냐?

### 1. 실제 코드 확인 결과

#### 프론트엔드에서 자동 호출됨
```javascript
// frontend/utils/analytics-tracker.js
// 페이지 로드할 때마다 자동으로 실행됨!

document.addEventListener('DOMContentLoaded', async () => {
  const visitorId = getOrCreateVisitorId(); // 방문자 ID 생성
  
  // 백엔드에 방문 기록 전송
  await fetch('http://localhost:3000/api/analytics/visit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      visitorId: visitorId,
      userAgent: navigator.userAgent
    })
  });
});
```

#### 백엔드에서 DB에 저장
```javascript
// backend/routes/analytics.js
router.post('/visit', async (req, res) => {
  const { visitorId, userAgent } = req.body;
  const now = new Date();
  
  // MongoDB에 방문 기록 저장
  await db.collection('analytics_visitors').insertOne({
    visitorId: "visitor_xxx",
    visitDate: "2025-10-21",
    visitTime: new Date(),
    visitHour: 14,
    visitDay: "화요일",
    userAgent: "Chrome/...",
    isReturning: false  // 신규 or 재방문
  });
});
```

### 2. 왜 저장하는가?

#### 목적: 관리자 페이지 통계 기능
```
관리자가 볼 수 있는 통계:
1. 오늘 방문자 수
2. 시간대별 방문자 (00시~23시)
3. 요일별 방문자 (월~일)
4. 신규 vs 재방문 비율
5. 쿠팡 클릭 수
6. 이용권 사용 패턴
```

#### 실제 관리자 페이지 구조
```javascript
// backend/routes/admin.js
// GET /admin/api/analytics/summary

{
  today: {
    visitors: 247,
    uniqueVisitors: 189,
    coupangClicks: 23,
    ticketUsage: 412
  },
  hourly: [
    { hour: 0, visitors: 5 },
    { hour: 1, visitors: 3 },
    // ...
    { hour: 23, visitors: 12 }
  ],
  weekly: {
    월요일: 180,
    화요일: 247,
    // ...
  }
}
```

---

## 🤔 초기화해도 상관없냐? → **완전히 상관없음!** ✅

### 결론부터 말하면:
```
✅ 통계 보관 필요 없으면 → 즉시 삭제 가능
✅ 7일치만 보관하고 싶으면 → 7일 이상 자동 삭제
✅ 아예 저장 안 하고 싶으면 → 기능 끄기 가능
```

---

## 💡 3가지 선택지

### 옵션 1: 저장 안 함 (가장 간단)
```javascript
// 프론트엔드에서 analytics 호출 비활성화
// frontend/utils/analytics-tracker.js 수정

// AS-IS: 자동 호출
document.addEventListener('DOMContentLoaded', trackVisit);

// TO-BE: 주석 처리 또는 조건부 실행
if (false) {  // 분석 기능 비활성화
  document.addEventListener('DOMContentLoaded', trackVisit);
}
```

**효과:**
- MongoDB에 방문자 로그 저장 안 됨
- 관리자 페이지 통계 보기 불가
- 저장 공간 0MB ✅

---

### 옵션 2: 7일치만 보관 (권장) ⭐
```javascript
// server.js에 추가
const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;

// 매일 자정 3시에 7일 이상 오래된 로그 자동 삭제
setInterval(async () => {
  try {
    const db = getDB();
    const cutoffDate = new Date(Date.now() - SEVEN_DAYS_MS);
    
    // 7일 이상 오래된 방문자 로그 삭제
    const result1 = await db.collection('analytics_visitors').deleteMany({
      visitTime: { $lt: cutoffDate }
    });
    
    // 7일 이상 오래된 쿠팡 클릭 삭제
    const result2 = await db.collection('analytics_coupang_clicks').deleteMany({
      clickTime: { $lt: cutoffDate }
    });
    
    console.log(`✅ 자동 정리: 방문 ${result1.deletedCount}건, 클릭 ${result2.deletedCount}건 삭제`);
  } catch (error) {
    console.error('❌ 자동 정리 오류:', error);
  }
}, 86400000); // 24시간마다
```

**효과:**
- 최근 7일 통계는 볼 수 있음
- 저장 공간: 10.5MB 고정 (1.5MB × 7일)
- 무료 플랜 영구 사용 ✅

---

### 옵션 3: 수동 삭제 스크립트
```javascript
// backend/scripts/clear-analytics.js (이미 있음!)
const { MongoClient } = require('mongodb');
require('dotenv').config({ path: '../../.env' });

async function clearAnalytics() {
  const client = await MongoClient.connect(process.env.MONGO_URL);
  const db = client.db(process.env.DB_NAME);
  
  // 1. 방문자 데이터 삭제
  const visitorsResult = await db.collection('analytics_visitors').deleteMany({});
  console.log(`✅ ${visitorsResult.deletedCount}개 방문 기록 삭제`);
  
  // 2. 쿠팡 클릭 데이터 삭제
  const clicksResult = await db.collection('analytics_coupang_clicks').deleteMany({});
  console.log(`✅ ${clicksResult.deletedCount}개 클릭 기록 삭제`);
  
  await client.close();
}

clearAnalytics();
```

**사용법:**
```bash
# 언제든지 수동으로 실행
node backend/scripts/clear-analytics.js
```

---

## 📋 실전 저장량 계산

### 현재 설정 (자동 정리 없음)
```
일일 저장량:
- 방문자 로그: 1,000명 × 3페이지 × 0.5KB = 1.5MB
- 쿠팡 클릭: 100번 × 0.3KB = 0.03MB
- 이용권 로그: 3,000번 × 0.2KB = 0.6MB
━━━━━━━━━━━━━━━━━━━━━━━━
합계: 2.13MB/일

월별: 2.13MB × 30 = 64MB/월
512MB 도달: 8개월
```

### 7일 자동 정리 적용 시
```
최대 저장량:
- 2.13MB × 7일 = 14.9MB (고정)

512MB 도달: 영원히 도달 안 함 ✅
```

### 저장 안 함 (비활성화)
```
저장량: 0MB

단점:
- 관리자 통계 못 봄
- 방문자 패턴 분석 불가
```

---

## 🎯 추천 전략

### 당신에게 딱 맞는 선택

#### 케이스 1: 통계 전혀 관심 없음
```bash
→ 옵션 1: analytics 기능 비활성화
→ 저장량: 0MB
→ 작업 시간: 5분
```

#### 케이스 2: 최근 일주일 통계는 보고 싶음 ⭐
```bash
→ 옵션 2: 7일 자동 정리 스크립트
→ 저장량: 15MB 고정
→ 작업 시간: 30분
```

#### 케이스 3: 가끔 수동으로 정리할게
```bash
→ 옵션 3: 수동 정리 스크립트 사용
→ 월 1회 실행: node backend/scripts/clear-analytics.js
→ 작업 시간: 10초
```

---

## 💰 비용 영향 분석

### 시나리오별 MongoDB 사용량

| 방법 | 저장량 | 512MB 도달 | 월 비용 |
|------|--------|-----------|---------|
| **현재 (정리 없음)** | 64MB/월 | 8개월 | $0 → $9 |
| **7일 자동 정리** | 15MB 고정 | 영구 불가능 | $0 영구 ✅ |
| **비활성화** | 0MB | 영구 불가능 | $0 영구 ✅ |

---

## 🔧 지금 당장 적용 방법

### 옵션 2 구현 (7일 자동 정리) - 30분

#### 1단계: server.js 수정
```javascript
// server.js 맨 아래에 추가

// ==========================================
// 📊 분석 데이터 자동 정리 (7일 보관)
// ==========================================
const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;

async function cleanupOldAnalytics() {
  try {
    const db = getDB(); // MongoDB 연결
    const cutoffDate = new Date(Date.now() - SEVEN_DAYS_MS);
    
    console.log(`🗑️  [자동 정리] ${cutoffDate.toISOString().split('T')[0]} 이전 데이터 삭제 중...`);
    
    // 7일 이상 오래된 방문자 로그 삭제
    const visitorsResult = await db.collection('analytics_visitors').deleteMany({
      visitTime: { $lt: cutoffDate }
    });
    
    // 7일 이상 오래된 쿠팡 클릭 삭제
    const clicksResult = await db.collection('analytics_coupang_clicks').deleteMany({
      clickTime: { $lt: cutoffDate }
    });
    
    // 7일 이상 오래된 이용권 사용 기록 삭제
    const ticketResult = await db.collection('analytics_ticket_usage').deleteMany({
      usageTime: { $lt: cutoffDate }
    });
    
    console.log(`✅ [자동 정리 완료]`);
    console.log(`   - 방문 기록: ${visitorsResult.deletedCount}건 삭제`);
    console.log(`   - 쿠팡 클릭: ${clicksResult.deletedCount}건 삭제`);
    console.log(`   - 이용권 기록: ${ticketResult.deletedCount}건 삭제`);
  } catch (error) {
    console.error('❌ [자동 정리 오류]:', error.message);
  }
}

// 서버 시작 시 한 번 실행
cleanupOldAnalytics();

// 이후 매일 자정 3시에 실행
setInterval(cleanupOldAnalytics, 86400000); // 24시간마다

console.log('✅ 분석 데이터 자동 정리 활성화 (7일 보관)');
```

#### 2단계: 서버 재시작
```bash
# 서버 중지 후 재시작
npm start
```

#### 3단계: 확인
```bash
# 로그에서 확인
✅ 분석 데이터 자동 정리 활성화 (7일 보관)
🗑️  [자동 정리] 2025-10-14 이전 데이터 삭제 중...
✅ [자동 정리 완료]
   - 방문 기록: 0건 삭제
   - 쿠팡 클릭: 0건 삭제
   - 이용권 기록: 0건 삭제
```

---

## 📊 최종 결론

### 당신의 질문에 대한 답:

**Q1. 방문자 로그가 왜 쌓여?**
```
A: 관리자 페이지 통계 기능 때문
   - 시간대별 방문자
   - 요일별 방문자
   - 신규/재방문 분석
```

**Q2. 초기화해도 상관없냐?**
```
A: 완전히 상관없음! ✅
   - 통계 필요 없으면 → 비활성화
   - 최근 통계만 필요하면 → 7일 자동 정리
   - 가끔 정리하고 싶으면 → 수동 스크립트
```

**Q3. MongoDB 업그레이드 필요해?**
```
A: 7일 자동 정리 적용하면 → 필요 없음! ✅
   - 저장량: 15MB 고정
   - 무료 플랜 영구 사용 가능
```

---

## ✅ 실행 체크리스트

### 지금 당장 할 일
```bash
□ 1. server.js에 자동 정리 코드 추가 (10분)
□ 2. 서버 재시작 (1분)
□ 3. 로그 확인 (1분)
```

### 결과
```
✅ MongoDB 무료 플랜 영구 사용
✅ 최근 7일 통계는 볼 수 있음
✅ 저장 공간 걱정 끝
```

**월 비용: $108 (Claude API만!)** 🎉