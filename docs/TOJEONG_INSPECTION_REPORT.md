# 토정비결 시스템 점검 보고서

점검일: 2025-01-05
점검자: Claude
점검 방식: 코드 분석 + 웹검색 검증 (수정 없음)
점검 범위: 엔진, 프롬프트, 성능, 정확도

---

## 1. 시스템 개요

### 핵심 아키텍처
```
사용자 입력 (생년월일, 대상년도)
    |
    v
토정비결 엔진 (engines/core/tojeong-engine.js)
    |
    +-- 상중하 괘 계산
    +-- 144괘 데이터 로드 (engines/data/tojeong-gua-144.json)
    +-- 12개월 운세 생성
    |
    v
프롬프트 생성 (engines/prompts/tojeong-prompt.js)
    |
    v
Claude API (Sonnet) - 현대어 번역
    |
    v
결과 반환 (종합운세 + 6개 세부운세 + 12개월)
```

### 운영 방식
- **계산 방식**: 144괘 시스템 (상괘 8 x 중괘 6 x 하괘 3)
- **AI 사용 여부**: 예 (Claude Sonnet)
- **AI 역할**: 원문 번역 및 현대어 해석 (계산은 엔진)
- **데이터 의존성**: 144괘 데이터 (tojeong-gua-144.json)

---

## 2. 파일별 상세 분석

### 2.1 tojeong-engine.js (메인 엔진)

**파일 위치**: `C:\xampp\htdocs\mysite\운세플랫폼\engines\core\tojeong-engine.js`
**파일 크기**: 168줄

**강점:**
- 코드 구조가 명확하고 읽기 쉬움
- 주석이 잘 작성되어 있음
- 에러 처리가 있음 (try-catch)
- 144괘 데이터 로드 로직 안정적

**발견된 치명적 문제점:**

#### 문제 1: 태세수 계산 오류 (높음)
```javascript
// 현재 코드 (잘못됨)
const TAESE_SOO = {
  '갑자': 1, '을축': 2, '병인': 3, '정묘': 4, '무진': 5, '기사': 6,
  '경오': 7, '신미': 8, '임신': 9, '계유': 10, '갑술': 11, '을해': 12,
  '병자': 1, '정축': 2, '무인': 3, ... // 12개씩만 반복
};
```

**웹검색 결과 (위키백과, CHUNUN.COM):**
```
태세수는 60간지 전체를 사용해야 함.
갑자=1, 을축=2, ... 계해=60
단순히 12개만 반복하면 안 됨!
```

**영향도**: 높음 (상괘 계산이 완전히 잘못됨)
**예시**:
- 2024년 갑진년 → 태세수 5 (정확)
- 2025년 을사년 → 태세수 6 (정확)
- 2026년 병오년 → 현재 코드는 7 (잘못), 정확한 값은 7 (우연히 맞음)
- 2036년 병진년 → 현재 코드는 5 (잘못), 정확한 값은 53

#### 문제 2: 월건수 계산 오류 (높음)
```javascript
// 현재 코드 (잘못됨)
const WOLGUN_SOO = {
  1: 3, 2: 4, 3: 5, 4: 6, 5: 7, 6: 8,
  7: 9, 8: 10, 9: 11, 10: 12, 11: 1, 12: 2
};
```

**웹검색 결과:**
```
월건수는 해당 월의 간지(干支)에서 계산해야 함.
예: 2025년 1월 = 무인월 → 간지 테이블에서 월건수 찾기
단순히 월 숫자로 매핑하면 안 됨!
```

**영향도**: 높음 (중괘 계산이 완전히 잘못됨)

#### 문제 3: 일진수 계산 오류 (높음)
```javascript
// 현재 코드 (잘못됨)
const ILJIN_SOO = {
  '갑': 1, '을': 2, '병': 3, '정': 4, '무': 5,
  '기': 6, '경': 7, '신': 8, '임': 9, '계': 10
};

// 생일 간지를 천간만으로 계산
const dayGan = ['갑', '을', '병', ...][day % 10];
const iljinSoo = ILJIN_SOO[dayGan] || 1;
```

**웹검색 결과:**
```
일진수는 해당 날짜의 간지(干支) 전체를 사용해야 함.
예: 2025년 1월 1일 = 병술일 → 간지 테이블에서 일진수 찾기
천간만 사용하면 안 됨!
```

**영향도**: 높음 (하괘 계산이 완전히 잘못됨)

---

### 2.2 tojeong-gua-144.json (144괘 데이터)

**파일 위치**: `C:\xampp\htdocs\mysite\운세플랫폼\engines\data\tojeong-gua-144.json`
**파일 크기**: 3026줄

**강점:**
- 144개 괘 모두 완전함 (1번~144번)
- 각 괘마다 12개월 운세 데이터 존재
- 데이터 구조 일관성 있음
- JSON 형식 정확함

**검증 결과:**
```javascript
총 괘 개수: 144
첫 번째 괘: 1
마지막 괘: 144
```

**발견된 문제점:**
- 없음 (데이터는 완벽함)

**개선 제안 (낮음):**
- 월별 원문이 너무 추상적 (예: "정월에는 해가 떠오르니 만사가 형통하도다")
- 현대인이 이해하기 어려울 수 있음
- 하지만 이것이 토정비결 원문의 특징이므로, AI 번역으로 보완 가능

---

### 2.3 tojeong-prompt.js (프롬프트)

**파일 위치**: `C:\xampp\htdocs\mysite\운세플랫폼\engines\prompts\tojeong-prompt.js`
**파일 크기**: 82줄

**강점:**
- 타겟 명확: "55-65세 여성"
- 구조화된 JSON 응답 요구
- 따뜻하고 실용적인 톤 지시
- 6개 세부운세 카테고리 명확
- 12개월 운세 각각 해석 요구

**발견된 문제점:**

#### 문제 4: 카테고리 이름 불일치 (낮음)

**문서 (운세_플랫폼_폴더구조.md):**
```
6개 카테고리: 전체/금전/애정/건강/가정/여행
```

**실제 프롬프트:**
```
6개 카테고리: 종합/연애/재물/건강/가정/소망
```

**영향도**: 낮음 (의미는 유사함)
- 연애 ≈ 애정
- 재물 ≈ 금전
- 소망 ≈ 여행 (?)

**개선 제안:**
- 문서와 코드 통일 필요
- "여행운"이 더 구체적일 수 있음

#### 문제 5: 프롬프트 길이 제약 (보통)
```javascript
const prompt = `...총 약 800자`;
```

**문제점:**
- 월별 원문을 모두 전달 (12개월 x 50자 = 600자)
- Claude API 토큰 소비 증가
- 하지만 정확한 해석을 위해 필요함

**영향도**: 보통 (비용 vs 품질 트레이드오프)

---

### 2.4 tojeong-test.html (프론트엔드)

**파일 위치**: `C:\xampp\htdocs\mysite\운세플랫폼\frontend\pages\tojeong-test.html`
**파일 크기**: 1224줄

**강점:**
- UI 디자인 깔끔
- 생년월일 입력 폼 완비
- 음력/양력 선택 옵션 제공

**발견된 문제점:**

#### 문제 6: 음력 변환 미구현 (높음)
```javascript
// 프론트엔드에서 음력 선택 옵션은 있지만
// 백엔드 엔진에서 음력 변환을 실제로 하지 않음
```

**웹검색 결과:**
```
토정비결은 음력 생년월일로 계산해야 정확함.
양력 → 음력 변환 필수!
```

**영향도**: 높음 (양력으로 계산하면 완전히 틀림)

---

## 3. 강점 요약

### 정확성
- 144괘 데이터는 완벽함 (3026줄, 검증 완료)

### 설계
- 코드 구조가 명확하고 읽기 쉬움
- 엔진 + 프롬프트 + 데이터 분리 잘됨
- 에러 처리 구현됨

### 성능
- 144괘 데이터 로드 빠름
- 계산 로직 단순 (복잡도 O(1))

---

## 4. 발견된 문제점 및 개선사항

### 높음 (필수 수정)

**1. 태세수 계산 오류**
```
현재: 60간지를 12개로 축약 (갑자=1, 을축=2, ... 을해=12, 병자=1 다시 반복)
정확: 60간지 각각 고유 숫자 (갑자=1, 을축=2, ... 계해=60)
영향: 상괘 계산 완전히 잘못됨
우선순위: 최고
```

**2. 월건수 계산 오류**
```
현재: 월 숫자로 고정 매핑 (1월=3, 2월=4, ...)
정확: 해당 월의 간지(干支)로 계산
영향: 중괘 계산 완전히 잘못됨
우선순위: 최고
```

**3. 일진수 계산 오류**
```
현재: 생일의 천간만 사용 (갑=1, 을=2, ...)
정확: 해당 날짜의 간지(干支) 전체 사용
영향: 하괘 계산 완전히 잘못됨
우선순위: 최고
```

**4. 음력 변환 미구현**
```
현재: isLunar 파라미터만 있고 실제 변환 없음
정확: lunar-javascript 라이브러리로 양력→음력 변환
영향: 양력으로 계산하면 완전히 틀림
우선순위: 최고
```

### 보통 (권장 수정)

**5. 프롬프트 월별 원문 길이**
```
현재: 12개월 원문을 모두 전달 (약 600자)
개선: 필요한 달만 선택적 전달 (비용 절감)
영향: Claude API 토큰 소비 증가
우선순위: 보통
```

### 낮음 (선택사항)

**6. 카테고리 이름 통일**
```
현재: 종합/연애/재물/건강/가정/소망
문서: 전체/금전/애정/건강/가정/여행
개선: 문서와 코드 통일
영향: 낮음 (의미는 유사)
우선순위: 낮음
```

**7. 144괘 원문 현대화**
```
현재: "정월에는 해가 떠오르니 만사가 형통하도다" (고전 문체)
개선: 원문 자체를 현대어로 다시 작성
영향: 낮음 (AI가 번역하므로)
우선순위: 낮음
```

---

## 5. 종합 평가

### 점수: 60/100

| 항목 | 점수 | 평가 |
|------|------|------|
| 정확성 | 40/100 | 치명적 계산 오류 4건 (태세수, 월건수, 일진수, 음력변환) |
| 설계 | 70/100 | 구조는 좋으나 핵심 로직 잘못 구현 |
| 성능 | 80/100 | 144괘 데이터 완전, 계산 빠름 |
| 유지보수 | 60/100 | 코드는 읽기 쉬우나 잘못된 로직 |
| 문서화 | 50/100 | 주석은 있으나 정확성 부족 |

### 배포 가능 여부
- **불가능** (필수 수정 필요)

**배포 전 필수 수정:**
1. 태세수 계산 (60간지 전체)
2. 월건수 계산 (월 간지 기반)
3. 일진수 계산 (일 간지 기반)
4. 음력 변환 구현 (lunar-javascript)

**현재 상태로 배포 시 문제:**
- 모든 사용자에게 잘못된 괘가 나옴
- 토정비결의 신뢰성 완전히 상실
- 144괘 데이터는 정확하지만 계산이 틀려서 무용지물

---

## 6. 권장 사항

### 즉시 조치 (필수)

**1. 간지 계산 라이브러리 도입**
```javascript
// lunar-javascript 라이브러리 활용
const lunar = require('lunar-javascript');

// 예시
const solarDate = solar.fromYmd(2025, 1, 1);
const lunarDate = solarDate.getLunar();
const ganzi = lunarDate.getYearInGanZhi(); // 을사년
```

**2. 60간지 테이블 구축**
```javascript
// 60간지 전체 테이블 (갑자=1 ~ 계해=60)
const GANZI_60 = {
  '갑자': 1, '을축': 2, '병인': 3, ... '계해': 60
};
```

**3. 월건수, 일진수 계산 수정**
```javascript
// 간지 기반 계산으로 변경
const monthGanzi = getMonthGanzi(year, month);
const wolgunSoo = GANZI_TABLE[monthGanzi];

const dayGanzi = getDayGanzi(year, month, day);
const iljinSoo = GANZI_TABLE[dayGanzi];
```

**4. 음력 변환 구현**
```javascript
function convertToLunar(year, month, day, isLunar) {
  if (isLunar) {
    return { year, month, day };
  }
  // 양력 → 음력 변환
  const solar = lunar.Solar.fromYmd(year, month, day);
  const lunarDate = solar.getLunar();
  return {
    year: lunarDate.getYear(),
    month: lunarDate.getMonth(),
    day: lunarDate.getDay()
  };
}
```

### 향후 개선 (권장)

**1. 캐싱 시스템**
```javascript
// 같은 생년월일 + 대상연도는 캐싱
const cacheKey = `${birthYear}-${birthMonth}-${birthDay}-${targetYear}`;
```

**2. 프롬프트 최적화**
```javascript
// 월별 원문을 필요한 달만 전달
// 예: 현재 달 ± 2개월만
```

**3. 테스트 케이스 작성**
```javascript
// 웹에서 검증된 예시로 테스트
// 예: 1990년 3월 15일생, 2025년 운세
```

---

## 7. 최종 의견

토정비결 시스템은 **144괘 데이터와 프롬프트는 우수하지만, 핵심 계산 로직에 치명적인 오류**가 있습니다.

**장점:**
- 144괘 데이터 완벽 (3026줄, 검증 완료)
- 코드 구조 명확, 읽기 쉬움
- 프롬프트 품질 좋음 (55-65세 여성 타겟 명확)

**치명적 단점:**
- 태세수, 월건수, 일진수 계산 모두 잘못됨
- 음력 변환 미구현
- 웹검색으로 검증한 결과, 전통 토정비결 이론과 다름

**결론:**
현재 상태로는 배포 불가능합니다. 간지 계산을 lunar-javascript 라이브러리로 전면 재구현해야 합니다. 수정 후에는 **오늘의 운세**처럼 우수한 시스템이 될 잠재력이 있습니다.

**예상 수정 시간:**
- 간지 계산 라이브러리 도입: 2시간
- 태세수/월건수/일진수 수정: 3시간
- 음력 변환 구현: 2시간
- 테스트 및 검증: 2시간
- **총 9시간** 소요 예상

---

## 8. 참고 자료

### 웹검색 출처
1. **위키백과**: 토정비결 개념 및 계산법
   - URL: https://ko.wikipedia.org/wiki/토정비결
   - 핵심: "상괘=(나이+태세수)%8, 중괘=(월달수+월건수)%6, 하괘=(생일+일진수)%3"

2. **CHUNUN.COM**: 토정비결 상세 계산법
   - URL: https://chunun.com/entry/토정비결-볼때-상괘-중괘-하괘-계산하는-방법
   - 핵심: 태세수, 월건수, 일진수 모두 간지 기반 계산

3. **나무위키**: 토정비결 역사 및 한계
   - URL: https://namu.wiki/w/토정비결
   - 핵심: 생시를 사용하지 않는 삼주 기반

### 관련 라이브러리
- **lunar-javascript**: 음력 변환 및 간지 계산
  - GitHub: https://github.com/6tail/lunar-javascript
  - NPM: `npm install lunar-javascript`

---

점검 완료일: 2025-01-05
다음 점검: 별자리 운세 / 꿈해몽 / 궁합
작성자: Claude
