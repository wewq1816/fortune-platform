# 📋 1달치 방문자 로그 자동 정리 시스템 - 수정 분석

## 🎯 목표
- 방문자 로그를 **1달(30일)치만 보관**
- 30일 이상 오래된 데이터 자동 삭제
- 매일 자정 3시에 자동 실행
- MongoDB 512MB 무료 플랜 영구 사용

---

## 📊 현재 상황 분석

### 1. MongoDB 구조 (2개 DB 연결)
```javascript
// server.js 1325-1360줄

Promise.all([
  // ① 티켓 시스템 MongoDB (getDB()로 접근)
  connectMongoDB().then(async () => {
    await TicketModel.ensureIndexes();
  }),
  
  // ② 관리자/분석 시스템 MongoDB (변수 db로 접근)
  MongoClient.connect(mongoUrl).then(client => {
    db = client.db(dbName);  // ← 이 db 변수 사용!
    adminRouter.initDB(db);
    analyticsRouter.initDB(db);  // ← 분석 데이터 저장
  })
])
```

### 2. 저장되는 컬렉션 (backend/routes/analytics.js 확인)
```javascript
// 1. 방문자 로그
db.collection('analytics_visitors').insertOne({
  visitorId: "visitor_xxx",
  visitDate: "2025-10-21",
  visitTime: new Date(),  // ← 이 필드로 삭제 판단
  visitHour: 14,
  visitDay: "화요일"
});

// 2. 쿠팡 클릭
db.collection('analytics_coupang_clicks').insertOne({
  visitorId: "visitor_xxx",
  clickDate: "2025-10-21",
  clickTime: new Date(),  // ← 이 필드로 삭제 판단
  clickHour: 14
});

// 3. 이용권 사용
db.collection('analytics_ticket_usage').insertOne({
  visitorId: "visitor_xxx",
  feature: "사주팔자",
  usageTime: new Date(),  // ← 이 필드로 삭제 판단
  remainingTickets: 8
});
```

### 3. 일별 저장량
```
- 방문자 로그: 1,000명 × 3페이지 × 0.5KB = 1.5MB
- 쿠팡 클릭: 100번 × 0.3KB = 0.03MB
- 이용권 사용: 3,000번 × 0.2KB = 0.6MB
━━━━━━━━━━━━━━━━━━━━━━━━
합계: 2.13MB/일

30일 보관: 2.13MB × 30 = 63.9MB (고정)
```

---

## 🔧 수정 방법

### 수정 파일
```
C:\xampp\htdocs\mysite\운세플랫폼\server.js
```

### 수정 위치
```
1356줄 - MongoDB 초기화 완료 후 (.then() 블록 안)
```

### 수정 내용

#### STEP 1: 상수 정의 추가 (1300줄 근처)
```javascript
// ========================================
// 🗑️ 분석 데이터 자동 정리 설정
// ========================================
const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;  // 30일
const CLEANUP_HOUR = 3;  // 매일 새벽 3시에 실행
```

#### STEP 2: 자동 정리 함수 추가 (1310줄 근처)
```javascript
/**
 * 30일 이상 오래된 분석 데이터 자동 삭제
 */
async function cleanupOldAnalytics() {
  try {
    // db 변수 확인 (관리자 시스템 DB)
    if (!db) {
      console.warn('⚠️  [자동 정리] DB 연결 안 됨 - 건너뜀');
      return;
    }
    
    // 30일 전 날짜 계산
    const cutoffDate = new Date(Date.now() - THIRTY_DAYS_MS);
    const cutoffDateStr = cutoffDate.toISOString().split('T')[0];
    
    console.log('\n' + '='.repeat(70));
    console.log('🗑️  [분석 데이터 자동 정리 시작]');
    console.log('시간:', new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }));
    console.log('기준 날짜:', cutoffDateStr, '이전 데이터 삭제');
    console.log('='.repeat(70));
    
    // 1. 30일 이상 오래된 방문자 로그 삭제
    const visitorsResult = await db.collection('analytics_visitors').deleteMany({
      visitTime: { $lt: cutoffDate }
    });
    console.log(`📊 방문자 로그: ${visitorsResult.deletedCount}건 삭제`);
    
    // 2. 30일 이상 오래된 쿠팡 클릭 삭제
    const clicksResult = await db.collection('analytics_coupang_clicks').deleteMany({
      clickTime: { $lt: cutoffDate }
    });
    console.log(`🔗 쿠팡 클릭: ${clicksResult.deletedCount}건 삭제`);
    
    // 3. 30일 이상 오래된 이용권 사용 기록 삭제
    const ticketResult = await db.collection('analytics_ticket_usage').deleteMany({
      usageTime: { $lt: cutoffDate }
    });
    console.log(`🎫 이용권 기록: ${ticketResult.deletedCount}건 삭제`);
    
    // 4. 현재 저장량 확인 (선택사항)
    const visitorsCount = await db.collection('analytics_visitors').countDocuments();
    const clicksCount = await db.collection('analytics_coupang_clicks').countDocuments();
    const ticketCount = await db.collection('analytics_ticket_usage').countDocuments();
    
    console.log('\n📈 현재 저장 상태:');
    console.log(`   방문자 로그: ${visitorsCount}건`);
    console.log(`   쿠팡 클릭: ${clicksCount}건`);
    console.log(`   이용권 기록: ${ticketCount}건`);
    console.log('='.repeat(70) + '\n');
    
  } catch (error) {
    console.error('\n❌ [자동 정리 오류]:', error.message);
    console.error('스택:', error.stack);
  }
}

/**
 * 자동 정리 스케줄러 시작
 */
function startCleanupScheduler() {
  // 다음 실행 시간 계산 (매일 새벽 3시)
  const now = new Date();
  const nextRun = new Date(now);
  nextRun.setHours(CLEANUP_HOUR, 0, 0, 0);
  
  // 이미 오늘 3시가 지났으면 내일 3시로 설정
  if (now.getHours() >= CLEANUP_HOUR) {
    nextRun.setDate(nextRun.getDate() + 1);
  }
  
  const msUntilNextRun = nextRun.getTime() - now.getTime();
  const hoursUntil = Math.floor(msUntilNextRun / (1000 * 60 * 60));
  const minutesUntil = Math.floor((msUntilNextRun % (1000 * 60 * 60)) / (1000 * 60));
  
  console.log('\n📅 [자동 정리 스케줄러 활성화]');
  console.log(`   첫 실행: ${nextRun.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}`);
  console.log(`   (${hoursUntil}시간 ${minutesUntil}분 후)`);
  console.log(`   이후: 매일 새벽 ${CLEANUP_HOUR}시 자동 실행`);
  console.log(`   보관 기간: 최근 30일\n`);
  
  // 첫 실행 예약
  setTimeout(() => {
    cleanupOldAnalytics();  // 첫 실행
    
    // 이후 매일 실행
    setInterval(cleanupOldAnalytics, 86400000);  // 24시간마다
  }, msUntilNextRun);
}
```

#### STEP 3: MongoDB 초기화 완료 후 실행 (1356줄 수정)
```javascript
// 기존 코드:
.then(() => {
  console.log('====================================');
  console.log('MongoDB 전체 초기화 완료');
  console.log('====================================');
})

// 수정 후:
.then(() => {
  console.log('====================================');
  console.log('MongoDB 전체 초기화 완료');
  console.log('====================================');
  
  // 🗑️ 분석 데이터 자동 정리 시작
  startCleanupScheduler();
})
```

---

## 📝 전체 수정 요약

### 수정 사항
1. **1300줄 근처**: 상수 정의 (`THIRTY_DAYS_MS`, `CLEANUP_HOUR`)
2. **1310줄 근처**: 함수 2개 추가 (`cleanupOldAnalytics`, `startCleanupScheduler`)
3. **1356줄**: `.then()` 블록에 `startCleanupScheduler()` 호출 추가

### 추가 코드 라인 수
- 약 100줄 추가

---

## ✅ 예상 결과

### 서버 시작 시 로그
```bash
====================================
MongoDB 전체 초기화 완료
====================================

📅 [자동 정리 스케줄러 활성화]
   첫 실행: 2025-10-22 03:00:00
   (14시간 35분 후)
   이후: 매일 새벽 3시 자동 실행
   보관 기간: 최근 30일
```

### 자정 3시 실행 시 로그
```bash
======================================================================
🗑️  [분석 데이터 자동 정리 시작]
시간: 2025-10-22 03:00:00
기준 날짜: 2025-09-22 이전 데이터 삭제
======================================================================
📊 방문자 로그: 4,500건 삭제
🔗 쿠팡 클릭: 150건 삭제
🎫 이용권 기록: 9,000건 삭제

📈 현재 저장 상태:
   방문자 로그: 90,000건
   쿠팡 클릭: 3,000건
   이용권 기록: 90,000건
======================================================================
```

---

## 📊 저장량 비교

### 수정 전 (자동 정리 없음)
```
일별: 2.13MB
월별: 63.9MB
512MB 도달: 8개월 후
```

### 수정 후 (30일 보관)
```
최대 저장량: 63.9MB (고정)
512MB 도달: 영원히 도달 안 함 ✅

여유 공간: 512MB - 64MB = 448MB
추가 보관 가능 기간: 7개월치 추가 저장 가능
```

---

## 🎯 장점

### 1. 무료 플랜 영구 사용 ✅
- MongoDB M0 (무료) 계속 사용 가능
- 업그레이드 불필요

### 2. 통계 기능 유지 ✅
- 최근 30일 통계는 확인 가능
- 관리자 페이지 정상 작동

### 3. 자동 관리 ✅
- 수동 작업 불필요
- 서버 재시작 후에도 자동 실행

### 4. 성능 유지 ✅
- 쿼리 속도 향상 (데이터 적을수록 빠름)
- DB 부하 감소

---

## ⚠️ 주의사항

### 1. 30일 이전 데이터는 복구 불가
```
삭제 후에는 복구 불가능
장기 보관 필요 시 → 백업 필요
```

### 2. 첫 실행 시점
```
서버 시작 시 → 다음 새벽 3시까지 대기
즉시 실행 원하면 → cleanupOldAnalytics() 직접 호출
```

### 3. 서버 재시작 필요
```
코드 수정 후 → 서버 재시작해야 적용
pm2 사용 시 → pm2 restart
```

---

## 🔧 테스트 방법

### 1. 수동 실행 테스트
```javascript
// server.js에서 즉시 실행 (테스트용)
.then(() => {
  console.log('MongoDB 전체 초기화 완료');
  
  // 즉시 실행 (테스트)
  cleanupOldAnalytics();
  
  // 스케줄러 시작
  startCleanupScheduler();
})
```

### 2. 로그 확인
```bash
# 서버 로그에서 확인
tail -f logs/system-*.log

# 또는 콘솔에서 직접 확인
node server.js
```

### 3. MongoDB에서 직접 확인
```javascript
// MongoDB 쿼리로 확인
db.analytics_visitors.countDocuments({
  visitTime: { 
    $lt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) 
  }
})
// 결과: 0건 (30일 이상 데이터 없음)
```

---

## 📋 최종 체크리스트

### 수정 전 확인
```bash
□ 현재 MongoDB 저장량 확인
□ 백업 필요 여부 결정
□ server.js 파일 백업
```

### 수정 중
```bash
□ 1300줄: 상수 정의 추가
□ 1310줄: 함수 2개 추가
□ 1356줄: startCleanupScheduler() 호출 추가
```

### 수정 후
```bash
□ 서버 재시작
□ 로그 확인 (스케줄러 활성화 메시지)
□ 다음 날 새벽 3시 실행 확인
```

---

## 💰 최종 비용

### 수정 전
```
월 비용: $108 (Claude) + $9 (MongoDB M10, 8개월 후)
        = $117/월 (8개월 후)
```

### 수정 후
```
월 비용: $108 (Claude) + $0 (MongoDB 무료 영구)
        = $108/월 ✅
```

**연간 절감액: $108 🎉**

---

## 🎉 결론

**수정 내용:**
- server.js에 약 100줄 코드 추가
- 3곳 수정 (상수 + 함수 + 실행)

**효과:**
- MongoDB 무료 플랫폼 영구 사용 ✅
- 최근 30일 통계는 유지 ✅
- 완전 자동화 ✅

**작업 시간: 30분**
**절감 비용: 연 $108**

지금 바로 수정하시겠습니까?