# 토정비결 완전 구현 가이드

**작성일**: 2025-10-04  
**목적**: 새로운 Claude 창에서 즉시 토정비결 시스템 구축 시작  
**프로젝트**: 운세플랫폼 (C:\xampp\htdocs\mysite\운세플랫폼\)

---

## 🎯 **1. 프로젝트 아키텍처 (반드시 숙지)**

### **핵심 원칙**
```
[입력] → [엔진(정확한 계산)] → [프롬프트 생성] → [Claude Haiku(해석만)] → [결과]
```

**중요**: Claude Haiku는 **계산 절대 안 시킴**. 오직 **자연어 번역만** 수행!

### **디렉토리 구조**
```
운세플랫폼/
├── engines/
│   ├── core/                    # 계산 엔진
│   │   ├── daily-engine.js      ✅ 완성
│   │   ├── horoscope-engine.js  ✅ 완성
│   │   ├── dream-engine.js      ✅ 완성
│   │   ├── lotto-engine.js      ✅ 완성
│   │   ├── compatibility-engine.js ✅ 완성
│   │   └── tojeong-engine.js    ❌ 비어있음 (구현 필요!)
│   ├── data/                    # 데이터 파일
│   │   └── tojeong-gua-144.json ❌ 없음 (생성 필요!)
│   ├── prompts/                 # Claude 프롬프트
│   │   ├── daily-fortune-prompt.js ✅ 완성
│   │   ├── horoscope-prompt.js     ✅ 완성
│   │   ├── compatibility-prompt.js ✅ 완성
│   │   └── tojeong-prompt.js    ❌ 없음 (생성 필요!)
│   └── utils/                   # 유틸리티
│       ├── saju-calculator.js   ✅ 완성
│       ├── ganzi-calculator.js  ✅ 완성
│       └── element-calculator.js ✅ 완성
│
├── frontend/
│   ├── index.html               ✅ 메인 페이지
│   └── pages/
│       ├── daily-fortune.html   ✅ 완성
│       ├── horoscope.html       ✅ 완성
│       ├── dream.html           ✅ 완성
│       ├── lotto.html           ✅ 완성
│       ├── compatibility-test.html ✅ 완성
│       └── tojeong.html         ❌ 없음 (생성 필요!)
│
└── server.js                    # Node.js 서버 (포트 3000)
```

---

## 📊 **2. 현재 상태 (Phase 1: 95% 완료)**

### **✅ 완성된 시스템 (참고용)**

| 시스템 | 엔진 | 프롬프트 | 프론트엔드 | 작동 |
|--------|------|----------|-----------|------|
| 오늘의 운세 | ✅ daily-engine.js | ✅ daily-fortune-prompt.js | ✅ daily-fortune.html | ✅ |
| 별자리 | ✅ horoscope-engine.js | ✅ horoscope-prompt.js | ✅ horoscope.html | ✅ |
| 꿈해몽 | ✅ dream-engine.js | (DB 검색) | ✅ dream.html | ✅ |
| 로또 | ✅ lotto-engine.js | (계산만) | ✅ lotto.html | ✅ |
| 궁합 | ✅ compatibility-engine.js | ✅ compatibility-prompt.js | ✅ compatibility-test.html | ✅ |

### **❌ 토정비결 (구현 필요!)**
- 엔진: ❌ 비어있음
- 프롬프트: ❌ 없음  
- 프론트엔드: ❌ 없음
- 데이터: ❌ 144괘 없음

---

## 🎯 **3. 토정비결 구현 계획 (5단계)**

### **우선순위 순서**
```
1단계: 144괘 데이터 생성     ← 가장 중요!
2단계: 엔진 구현 (계산 로직)
3단계: 프롬프트 생성기
4단계: 프론트엔드 (UI)
5단계: 서버 API 연동
```

---

## 📝 **4. 1단계: 144괘 데이터 생성**

### **파일**: `engines/data/tojeong-gua-144.json`

### **데이터 구조**
```json
{
  "1": {
    "number": 1,
    "name": "건지건(乾之乾)",
    "symbol": "☰☰",
    "level": "대길",
    "description": "하늘이 하늘을 만나니 대길한 괘이다",
    "monthly": {
      "1": "정월에는 해가 떠오르니 만사가 형통하도다",
      "2": "2월에는 봄기운이 완연하니 새싹이 돋아나도다",
      "3": "3월에는 꽃이 활짝 피니 기쁨이 가득하도다",
      "4": "4월에는 나무가 무성하니 성장의 시기로다",
      "5": "5월에는 열매가 맺히니 노력의 결실이로다",
      "6": "6월에는 햇살이 뜨거우니 열정을 발휘할 때",
      "7": "7월에는 장마가 오니 인내가 필요한 때",
      "8": "8월에는 가을바람 부니 수확의 계절이로다",
      "9": "9월에는 단풍이 드니 변화를 맞이할 때",
      "10": "10월에는 서리가 내리니 준비가 필요하도다",
      "11": "11월에는 겨울이 오니 휴식을 취할 때",
      "12": "12월에는 한 해를 마무리하니 반성의 시간"
    }
  },
  "2": {
    "number": 2,
    "name": "건지태(乾之兌)",
    "symbol": "☰☱",
    "level": "길",
    "description": "하늘이 못을 만나니 기쁨이 있는 괘이다",
    "monthly": {
      "1": "정월에는 웃음꽃이 피니 즐거운 시작이로다",
      ...
    }
  },
  ...
  "144": {
    ...
  }
}
```

### **레벨 분류**
- 대길(大吉): ⭐⭐⭐⭐⭐
- 길(吉): ⭐⭐⭐⭐
- 중길(中吉): ⭐⭐⭐
- 소길(小吉): ⭐⭐
- 평(平): ⭐
- 흉(凶): (별 없음)

---

## 🔧 **5. 2단계: 엔진 구현**

### **파일**: `engines/core/tojeong-engine.js`

```javascript
/**
 * 토정비결 계산 엔진
 * 
 * 핵심: 144괘 시스템 (상중하 3괘 조합)
 */

// 태세수 (년 간지)
const TAESE_SOO = {
  '갑자': 1, '을축': 2, '병인': 3, '정묘': 4, '무진': 5, '기사': 6,
  '경오': 7, '신미': 8, '임신': 9, '계유': 10, '갑술': 11, '을해': 12,
  '병자': 1, '정축': 2, '무인': 3, '기묘': 4, '경진': 5, '신사': 6,
  '임오': 7, '계미': 8, '갑신': 9, '을유': 10, '병술': 11, '정해': 12,
  '무자': 1, '기축': 2, '경인': 3, '신묘': 4, '임진': 5, '계사': 6,
  '갑오': 7, '을미': 8, '병신': 9, '정유': 10, '무술': 11, '기해': 12,
  '경자': 1, '신축': 2, '임인': 3, '계묘': 4, '갑진': 5, '을사': 6,
  '병오': 7, '정미': 8, '무신': 9, '기유': 10, '경술': 11, '신해': 12,
  '임자': 1, '계축': 2, '갑인': 3, '을묘': 4, '병진': 5, '정사': 6,
  '무오': 7, '기미': 8, '경신': 9, '신유': 10, '임술': 11, '계해': 12
};

// 월건수
const WOLGUN_SOO = {
  1: 3, 2: 4, 3: 5, 4: 6, 5: 7, 6: 8,
  7: 9, 8: 10, 9: 11, 10: 12, 11: 1, 12: 2
};

// 일진수 (간지 → 숫자)
const ILJIN_SOO = {
  '갑': 1, '을': 2, '병': 3, '정': 4, '무': 5,
  '기': 6, '경': 7, '신': 8, '임': 9, '계': 10
};

/**
 * 연도의 간지 계산
 */
function getYearGanzi(year) {
  const ganList = ['경', '신', '임', '계', '갑', '을', '병', '정', '무', '기'];
  const jiList = ['신', '유', '술', '해', '자', '축', '인', '묘', '진', '사', '오', '미'];
  
  const ganIndex = year % 10;
  const jiIndex = year % 12;
  
  return ganList[ganIndex] + jiList[jiIndex];
}

/**
 * 월별 일수 계산
 */
function getDaysInMonth(year, month, isLunar = false) {
  if (isLunar) {
    // 음력: 큰달 30일, 작은달 29일 (간단 구현)
    const smallMonths = [4, 6, 9, 11];
    return smallMonths.includes(month) ? 29 : 30;
  } else {
    // 양력
    return new Date(year, month, 0).getDate();
  }
}

/**
 * 토정비결 메인 계산 함수
 */
function calculateTojeong(birthInfo, targetYear) {
  const { year, month, day, isLunar = false } = birthInfo;
  
  try {
    // 1. 나이 계산
    const age = targetYear - year + 1;
    
    // 2. 연도 간지
    const yearGanzi = getYearGanzi(targetYear);
    const taeseSoo = TAESE_SOO[yearGanzi] || 1;
    
    // 3. 월건수
    const wolgunSoo = WOLGUN_SOO[month] || 1;
    
    // 4. 생일 간지 (간단 계산 - 실제로는 만세력 필요)
    const dayGan = ['갑', '을', '병', '정', '무', '기', '경', '신', '임', '계'][day % 10];
    const iljinSoo = ILJIN_SOO[dayGan] || 1;
    
    // 5. 상중하 계산
    const sangSu = (age + taeseSoo) % 8 || 8;
    const monthDays = getDaysInMonth(targetYear, month, isLunar);
    const jungSu = (monthDays + wolgunSoo) % 6 || 6;
    const haSu = (day + iljinSoo) % 3 || 3;
    
    // 6. 144괘 번호 계산
    // 상괘(8) × 중괘(6) × 하괘(3) = 144가지
    const guaNumber = ((sangSu - 1) * 18) + ((jungSu - 1) * 3) + haSu;
    
    // 7. 괘 데이터 로드
    const guaData = require('../data/tojeong-gua-144.json');
    const mainGua = guaData[guaNumber.toString()];
    
    if (!mainGua) {
      throw new Error(`괘 번호 ${guaNumber}를 찾을 수 없습니다.`);
    }
    
    // 8. 12개월 운세 생성
    const monthlyFortune = [];
    for (let m = 1; m <= 12; m++) {
      monthlyFortune.push({
        month: m,
        text: mainGua.monthly[m.toString()] || '운세 정보 없음'
      });
    }
    
    return {
      success: true,
      year: targetYear,
      yearGanzi: yearGanzi,
      age: age,
      calculation: {
        sangSu: sangSu,
        jungSu: jungSu,
        haSu: haSu,
        guaNumber: guaNumber
      },
      mainGua: {
        number: mainGua.number,
        name: mainGua.name,
        symbol: mainGua.symbol,
        level: mainGua.level,
        description: mainGua.description
      },
      monthlyFortune: monthlyFortune
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

module.exports = {
  calculateTojeong
};
```

---

## 💬 **6. 3단계: 프롬프트 생성기**

### **파일**: `engines/prompts/tojeong-prompt.js`

```javascript
/**
 * 토정비결 Claude API 프롬프트 생성기
 */

function generateTojeongPrompt(tojeongData) {
  const { year, yearGanzi, mainGua, monthlyFortune } = tojeongData;
  
  // 월별 원문 텍스트 조합
  const monthlyText = monthlyFortune.map((m, i) => 
    `${i + 1}월: ${m.text}`
  ).join('\n');
  
  const prompt = `당신은 30년 경력의 토정비결 전문가입니다. 55-65세 여성 고객에게 따뜻하고 실용적인 조언을 제공합니다.

# 고객 정보
- 연도: ${year}년 ${yearGanzi}년
- 연간 주괘: ${mainGua.name} ${mainGua.symbol}
- 괘의 의미: ${mainGua.description}
- 운세 등급: ${mainGua.level}

# 월별 원문 (144괘 토정비결)
${monthlyText}

# 작성 지침
1. **종합운세**: 200-350자
   - ${year}년 전체 흐름 요약
   - 주괘 ${mainGua.name}의 의미를 현대적으로 해석
   - 한 해를 어떻게 보내면 좋을지 구체적 조언
   
2. **월별운세**: 각 150-250자
   - 원문을 55-65세 여성이 이해하기 쉽게 현대어로 풀이
   - 그 달에 주의할 점, 좋은 일, 조심할 일
   - 구체적인 행동 조언 (예: "이달에는 건강검진을 받아보세요")

3. **어조**:
   - 따뜻하고 격려하는 톤
   - "~하세요", "~해보세요" 같은 친근한 말투
   - 부정적 내용도 희망적으로 표현

# 요청사항
다음 JSON 형식으로 정확히 작성해주세요:

{
  "종합운세": "2025년 을사년은...",
  "월별운세": {
    "1월": "정월은...",
    "2월": "2월은...",
    "3월": "3월은...",
    "4월": "4월은...",
    "5월": "5월은...",
    "6월": "6월은...",
    "7월": "7월은...",
    "8월": "8월은...",
    "9월": "9월은...",
    "10월": "10월은...",
    "11월": "11월은...",
    "12월": "12월은..."
  }
}

**중요**: 반드시 유효한 JSON 형식으로만 응답해주세요!`;

  return prompt;
}

module.exports = {
  generateTojeongPrompt
};
```

---

## 🎨 **7. 4단계: 프론트엔드**

### **파일**: `frontend/pages/tojeong.html`

**중요**: 기존 페이지(`daily-fortune.html`, `compatibility-test.html`)와 **완전히 동일한 스타일** 사용!

### **핵심 스타일 규칙**
```css
.container {
  max-width: 500px;
  width: 100%;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.back-btn {
  padding: 8px 15px;
  background: #f0f0f0;
  border-radius: 20px;
}

.top-buttons {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

/* 폰트 */
font-family: 'Malgun Gothic', sans-serif;
```

### **HTML 구조** (간단 버전)
```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>토정비결 - 우리의 운세</title>
  <style>
    /* 기존 페이지와 동일한 스타일 복사 */
  </style>
</head>
<body>
  <div class="container">
    <!-- 상단 버튼 -->
    <div class="top-buttons">
      <a href="../index.html" class="back-btn">← 홈으로</a>
    </div>
    
    <!-- 헤더 -->
    <div class="header">
      <h1>📿 토정비결</h1>
      <p>토정 이지함의 144괘로 보는 한 해 운세</p>
    </div>
    
    <!-- 입력 폼 -->
    <div id="inputSection" class="input-section">
      <!-- 생년월일 입력 -->
      <!-- 양력/음력 선택 -->
      <!-- 연도 선택 -->
      <button onclick="getTojeong()">토정비결 보기</button>
    </div>
    
    <!-- 로딩 -->
    <div id="loading" class="hidden">
      <div class="spinner"></div>
      <p>토정 이지함의 지혜를 불러오는 중...</p>
    </div>
    
    <!-- 결과 화면 -->
    <div id="result" class="hidden">
      <!-- 연도 정보 -->
      <!-- 괘 정보 -->
      <!-- 종합 운세 -->
      <!-- 12개월 카드 -->
    </div>
  </div>
  
  <script>
    async function getTojeong() {
      // API 호출
      const response = await fetch('http://localhost:3000/api/tojeong', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ year, month, day, isLunar, targetYear })
      });
      
      const data = await response.json();
      // 결과 표시
    }
  </script>
</body>
</html>
```

---

## 🚀 **8. 5단계: 서버 API**

### **파일**: `server.js` (추가)

```javascript
// 토정비결 API
app.post('/api/tojeong', async (req, res) => {
  try {
    const { year, month, day, isLunar, targetYear } = req.body;
    
    console.log('토정비결 요청:', { year, month, day, isLunar, targetYear });
    
    // 1. 엔진 계산
    const { calculateTojeong } = require('./engines/core/tojeong-engine');
    const tojeongData = calculateTojeong(
      { year, month, day, isLunar },
      targetYear
    );
    
    if (!tojeongData.success) {
      return res.status(400).json({ 
        success: false,
        error: tojeongData.error || '토정비결 계산 실패' 
      });
    }
    
    // 2. 프롬프트 생성
    const { generateTojeongPrompt } = require('./engines/prompts/tojeong-prompt');
    const prompt = generateTojeongPrompt(tojeongData);
    
    // 3. Claude API 호출
    console.log('Claude API 호출 중...');
    const message = await anthropic.messages.create({
      model: 'claude-3-haiku-20240307',
      max_tokens: 5000,  // 12개월 + 종합 = 많은 토큰
      messages: [{
        role: 'user',
        content: prompt
      }]
    });
    
    // 4. 응답 파싱
    const responseText = message.content[0].text;
    console.log('Claude 응답:', responseText.substring(0, 200) + '...');
    
    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
    let fortuneResult;
    
    if (jsonMatch) {
      fortuneResult = JSON.parse(jsonMatch[0]);
    } else {
      fortuneResult = { 
        종합운세: responseText,
        월별운세: {}
      };
    }
    
    // 5. 결과 반환
    res.json({
      success: true,
      year: tojeongData.year,
      yearGanzi: tojeongData.yearGanzi,
      age: tojeongData.age,
      mainGua: tojeongData.mainGua,
      monthlyFortune: tojeongData.monthlyFortune,
      fortune: fortuneResult,
      cost: (
        message.usage.input_tokens / 1000 * 0.00025 + 
        message.usage.output_tokens / 1000 * 0.00125
      ).toFixed(6)
    });
    
    console.log('토정비결 생성 완료!');
    
  } catch (error) {
    console.error('토정비결 오류:', error);
    res.status(500).json({ 
      success: false,
      error: error.message 
    });
  }
});
```

---

## ⚡ **9. 즉시 시작 가이드**

### **새 Claude 창에서 시작할 때**

#### **Step 1: 현재 위치 확인**
```bash
cd C:\xampp\htdocs\mysite\운세플랫폼
```

#### **Step 2: 1단계부터 시작**
```
"144괘 데이터 생성부터 시작합니다"
```

#### **Step 3: 순서대로 진행**
1. ✅ 144괘 데이터 생성 (`engines/data/tojeong-gua-144.json`)
2. ✅ 엔진 구현 (`engines/core/tojeong-engine.js`)
3. ✅ 프롬프트 생성기 (`engines/prompts/tojeong-prompt.js`)
4. ✅ 프론트엔드 (`frontend/pages/tojeong.html`)
5. ✅ 서버 API (`server.js` 수정)
6. ✅ 테스트

---

## 📋 **10. 중요 참고사항**

### **Claude Haiku 사용 규칙**
- ✅ 자연어 번역만 시킴
- ❌ 계산 절대 안 시킴
- ✅ JSON 형식 응답 요청
- ✅ max_tokens: 5000 (12개월이라 많이 필요)

### **스타일 일관성**
- 기존 페이지 스타일 **반드시 복사**
- 500px 컨테이너
- 20px 둥근 모서리
- Malgun Gothic 폰트

### **테스트 방법**
```bash
# 서버 시작
node server.js

# 브라우저에서
http://localhost:3000/pages/tojeong.html
```

---

## 🎯 **다음 작업 명령어**

새 Claude 창에서 다음처럼 시작하세요:

```
"토정비결 구현을 시작합니다. 
C:\xampp\htdocs\mysite\운세플랫폼\docs\토정비결_완전_구현_가이드.md 
문서를 읽고 1단계 144괘 데이터 생성부터 시작해주세요."
```

---

**🎊 이 문서 하나면 새 창에서 즉시 시작 가능합니다!**
